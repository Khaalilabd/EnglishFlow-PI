<div class="p-6 space-y-6 max-w-7xl mx-auto">
  <!-- Header with Back Button -->
  <div class="flex items-center justify-between">
    <button (click)="goBack()" class="flex items-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
      <i class="fas fa-arrow-left mr-2"></i>
      Back to Complaints
    </button>
    <button (click)="openActionModal()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg">
      <i class="fas fa-bolt mr-2"></i>Take Action
    </button>
  </div>

  <div *ngIf="isLoading" class="text-center py-12">
    <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
  </div>

  <div *ngIf="!isLoading && complaint" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Complaint Info + Conversation -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Complaint Information -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          <i class="fas fa-exclamation-circle text-amber-500 mr-2"></i>
          Complaint Information
        </h2>
        
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Subject</label>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ complaint.subject }}</p>
          </div>

          <div>
            <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Description</label>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">{{ complaint.description }}</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Student</label>
              <p class="text-gray-900 dark:text-white font-medium">{{ complaint.username }}</p>
              <p class="text-sm text-gray-500">{{ complaint.userEmail }}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Submitted</label>
              <p class="text-gray-900 dark:text-white">{{ complaint.createdAt | date:'medium' }}</p>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Category</label>
              <p class="text-gray-900 dark:text-white">{{ complaint.category }}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Priority</label>
              <p><span [class]="getPriorityClass(complaint.priority)" class="px-3 py-1 text-xs font-semibold rounded-full">
                {{ complaint.priority }}
              </span></p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Status</label>
              <p><span [class]="getStatusClass(complaint.status)" class="px-3 py-1 text-xs font-semibold rounded-full">
                {{ complaint.status }}
              </span></p>
            </div>
          </div>

          <!-- Additional Details Based on Category -->
          <div *ngIf="complaint.issueType || complaint.courseType || complaint.sessionCount || complaint.difficulty" 
               class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
            <label class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-3 block">
              <i class="fas fa-info-circle mr-2"></i>Additional Details
            </label>
            <div class="grid grid-cols-2 gap-4">
              <div *ngIf="complaint.issueType">
                <label class="text-xs text-gray-500 dark:text-gray-400">Issue Type</label>
                <p class="text-gray-900 dark:text-white font-medium">{{ complaint.issueType }}</p>
              </div>
              <div *ngIf="complaint.courseType">
                <label class="text-xs text-gray-500 dark:text-gray-400">Course</label>
                <p class="text-gray-900 dark:text-white font-medium">{{ complaint.courseType }}</p>
              </div>
              <div *ngIf="complaint.sessionCount">
                <label class="text-xs text-gray-500 dark:text-gray-400">Sessions Affected</label>
                <p class="text-gray-900 dark:text-white font-medium">{{ complaint.sessionCount }}</p>
              </div>
              <div *ngIf="complaint.difficulty">
                <label class="text-xs text-gray-500 dark:text-gray-400">Difficulty/Details</label>
                <p class="text-gray-900 dark:text-white font-medium">{{ complaint.difficulty }}</p>
              </div>
            </div>
          </div>

          <!-- Severity and Days Open Badges -->
          <div class="flex gap-3 pt-2">
            <span [class]="getSeverityBadge(complaint.priority).class" class="px-4 py-2 text-white text-sm font-bold rounded-lg">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              {{ getSeverityBadge(complaint.priority).text }}
            </span>
          </div>
        </div>
      </div>

      <!-- Complaint Conversation -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          <i class="fas fa-comments text-blue-500 mr-2"></i>
          Conversation
        </h2>

        <div class="space-y-4 mb-4 max-h-96 overflow-y-auto">
          <div *ngIf="messages.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-inbox text-4xl mb-2"></i>
            <p>No messages yet. Start the conversation!</p>
          </div>

          <div *ngFor="let message of messages"
     class="p-4 rounded-lg max-w-[75%] break-words"
     [ngClass]="message.isAdmin ? 'admin-message' : 'student-message'">
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="font-semibold text-gray-900 dark:text-white">{{ message.author }}</span>
                <span class="ml-2 px-2 py-1 text-xs rounded-full"
                      [class.bg-amber-100]="message.isAdmin"
                      [class.text-amber-800]="message.isAdmin"
                      [class.bg-gray-200]="!message.isAdmin"
                      [class.text-gray-800]="!message.isAdmin">
                  {{ message.authorRole }}
                </span>
              </div>
              <span class="text-xs text-gray-500">{{ message.timestamp | date:'short' }}</span>
            </div>
            <p class="text-gray-700 dark:text-gray-300">{{ message.content }}</p>
          </div>
        </div>

        <!-- New Message Input -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <textarea
            [(ngModel)]="newMessage"
            rows="3"
            placeholder="Type your message to the student..."
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"></textarea>
          <div class="flex justify-end mt-2">
            <button (click)="sendMessage()" 
                    [disabled]="!newMessage.trim()"
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-paper-plane mr-2"></i>Send Message
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: History Timeline -->
    <div class="lg:col-span-1">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 sticky top-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          <i class="fas fa-history text-purple-500 mr-2"></i>
          History Timeline
        </h2>

        <div class="space-y-4">
          <div *ngIf="complaintHistory.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-clock text-3xl mb-2"></i>
            <p class="text-sm">No history yet</p>
          </div>

          <div *ngFor="let item of complaintHistory; let last = last" class="relative">
            <!-- Timeline line -->
            <div *ngIf="!last" class="absolute left-3 top-8 bottom-0 w-0.5 bg-gray-300 dark:bg-gray-600"></div>
            
            <!-- Timeline item -->
            <div class="flex items-start">
              <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center z-10"
                   [class.bg-red-500]="item.isEscalation"
                   [class.bg-blue-500]="!item.isEscalation">
                <i class="fas fa-circle text-white text-xs"></i>
              </div>
              <div class="ml-4 flex-1">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                  <div class="flex justify-between items-start mb-1">
                    <span class="font-semibold text-sm text-gray-900 dark:text-white">
                      {{ item.fromStatus }} â†’ {{ item.toStatus }}
                    </span>
                    <span *ngIf="item.isEscalation" class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-bold">
                      ESCALATION
                    </span>
                  </div>
                  <p class="text-xs text-gray-600 dark:text-gray-400">by {{ item.actorName || item.actorRole }}</p>
                  <p *ngIf="item.comment" class="text-sm text-gray-700 dark:text-gray-300 mt-1">{{ item.comment }}</p>
                  <p *ngIf="item.escalationReason" class="text-sm text-red-600 dark:text-red-400 mt-1">
                    <i class="fas fa-exclamation-triangle"></i> {{ item.escalationReason }}
                  </p>
                  <p class="text-xs text-gray-500 mt-1">{{ item.timestamp | date:'short' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Action Modal -->
<div *ngIf="showActionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
        <i class="fas fa-bolt text-amber-500 mr-2"></i>Take Action
      </h2>
      <button (click)="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    
    <div class="p-6 space-y-4">
      <p class="text-gray-600 dark:text-gray-400">Choose an action to perform on this complaint:</p>
      
      <div class="grid grid-cols-2 gap-3">
        <button (click)="selectedAction = 'ESCALATE'" 
                [class.ring-2]="selectedAction === 'ESCALATE'"
                [class.ring-orange-500]="selectedAction === 'ESCALATE'"
                class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-orange-500 transition-all text-left">
          <i class="fas fa-arrow-up text-orange-500 text-xl mb-2"></i>
          <p class="font-semibold text-gray-900 dark:text-white">Escalate Priority</p>
          <p class="text-xs text-gray-500">Increase urgency level</p>
        </button>

        <button (click)="selectedAction = 'IN_PROGRESS'" 
                [class.ring-2]="selectedAction === 'IN_PROGRESS'"
                [class.ring-yellow-500]="selectedAction === 'IN_PROGRESS'"
                class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-yellow-500 transition-all text-left">
          <i class="fas fa-tasks text-yellow-500 text-xl mb-2"></i>
          <p class="font-semibold text-gray-900 dark:text-white">Mark In Progress</p>
          <p class="text-xs text-gray-500">Currently working on it</p>
        </button>

        <button (click)="selectedAction = 'RESOLVE'" 
                [class.ring-2]="selectedAction === 'RESOLVE'"
                [class.ring-green-500]="selectedAction === 'RESOLVE'"
                class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-green-500 transition-all text-left">
          <i class="fas fa-check-circle text-green-500 text-xl mb-2"></i>
          <p class="font-semibold text-gray-900 dark:text-white">Resolve Complaint</p>
          <p class="text-xs text-gray-500">Mark as resolved</p>
        </button>

        <button (click)="selectedAction = 'REJECT'" 
                [class.ring-2]="selectedAction === 'REJECT'"
                [class.ring-red-500]="selectedAction === 'REJECT'"
                class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-red-500 transition-all text-left">
          <i class="fas fa-times-circle text-red-500 text-xl mb-2"></i>
          <p class="font-semibold text-gray-900 dark:text-white">Reject Complaint</p>
          <p class="text-xs text-gray-500">Decline the complaint</p>
        </button>
      </div>

      <!-- Action Details -->

      <div class="flex justify-end space-x-3 mt-6">
        <button (click)="closeModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
          Cancel
        </button>
        <button (click)="executeAction()" 
                [disabled]="!selectedAction"
                class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-check mr-2"></i>Execute Action
        </button>
      </div>
    </div>
  </div>
</div>
