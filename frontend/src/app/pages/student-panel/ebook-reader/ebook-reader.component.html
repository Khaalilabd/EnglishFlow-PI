<!-- Loading State -->
<div *ngIf="isLoading" class="fixed inset-0 bg-gray-700 flex items-center justify-center z-50">
  <div class="text-center">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-gray-900 mx-auto mb-4"></div>
    <p class="text-gray-900 text-xl font-semibold">Loading your book...</p>
  </div>
</div>

<!-- Fullscreen PDF Flipbook Reader - Exact replica of the image -->
<div *ngIf="!isLoading && pages.length > 0" 
     class="fixed inset-0 bg-gray-700 overflow-hidden">
  
  <!-- Page Counter (Top Left) -->
  <div class="absolute top-4 left-4 text-white text-sm font-medium z-20">
    {{ currentPage > 1 ? currentPage - 1 : currentPage }} / {{ totalPages }}
  </div>
  
  <!-- Book Container with 3D Perspective -->
  <div class="absolute inset-0 flex items-center justify-center" style="perspective: 2500px;">
    
    <!-- 3D Book -->
    <div class="book-3d relative" 
         style="width: 85vw; max-width: 1200px; height: 80vh; max-height: 800px; transform-style: preserve-3d;"
         (mousedown)="onMouseDown($event)"
         (mousemove)="onMouseMove($event)"
         (mouseleave)="onMouseLeave()"
         (mouseup)="onMouseUp($event)">
      
      <!-- Book Shadow -->
      <div class="absolute inset-0 bg-black/50 blur-3xl transform translate-y-12 scale-90 -z-10"></div>
      
      <!-- Book Pages Container -->
      <div class="book-pages absolute inset-0 bg-white shadow-2xl flex transition-transform duration-300" 
           [style.transform]="'scale(' + zoomLevel + ')'"
           style="transform-origin: center center;">
        
        <!-- Left Page -->
        <div class="page-left w-1/2 relative bg-white overflow-hidden"
             style="box-shadow: inset -10px 0 20px rgba(0,0,0,0.1);">
          <img *ngIf="currentPage > 1 && pages[currentPage - 2]" 
               [src]="pages[currentPage - 2]" 
               class="w-full h-full object-contain p-8"
               alt="Page {{currentPage - 1}}">
          <div *ngIf="currentPage <= 1" class="w-full h-full bg-white"></div>
          
          <!-- Page Number -->
          <div *ngIf="currentPage > 1" class="absolute bottom-6 left-0 right-0 text-center text-gray-600 text-xs">
            {{ currentPage - 1 }}
          </div>
        </div>
        
        <!-- Center Spine with 3D effect -->
        <div class="absolute left-1/2 top-0 bottom-0 w-2 transform -translate-x-1/2 z-10"
             style="background: linear-gradient(90deg, 
                    rgba(0,0,0,0.2) 0%, 
                    rgba(0,0,0,0.1) 20%, 
                    rgba(255,255,255,0.05) 50%, 
                    rgba(0,0,0,0.1) 80%, 
                    rgba(0,0,0,0.2) 100%);
                    box-shadow: 0 0 15px rgba(0,0,0,0.3);">
        </div>
        
        <!-- Right Page with curl effect -->
        <div class="page-right w-1/2 relative bg-white overflow-hidden"
             style="box-shadow: inset 10px 0 20px rgba(0,0,0,0.1);">
          <img *ngIf="pages[currentPage - 1]" 
               [src]="pages[currentPage - 1]" 
               class="w-full h-full object-contain p-8"
               alt="Page {{currentPage}}">
          <div *ngIf="!pages[currentPage - 1]" class="w-full h-full bg-white"></div>
          
          <!-- Page Number -->
          <div *ngIf="pages[currentPage - 1]" class="absolute bottom-6 left-0 right-0 text-center text-gray-600 text-xs">
            {{ currentPage }}
          </div>
          
          <!-- Page Curl Effect (Bottom Right Corner) -->
          <div class="absolute bottom-0 right-0 w-20 h-20 pointer-events-none overflow-hidden opacity-30">
            <div class="absolute bottom-0 right-0 w-full h-full"
                 style="background: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.1));
                        transform: rotate(0deg);
                        transform-origin: bottom right;
                        box-shadow: -2px -2px 8px rgba(0,0,0,0.15);">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Page Flip Animation Overlay with Realistic 3D Flip -->
      <div *ngIf="isFlipping" class="absolute inset-0 pointer-events-none z-30 flex items-center justify-center"
           style="perspective: 2500px; perspective-origin: center center;">
        
        <!-- Forward Flip (Right page flipping left) with Slices -->
        <div *ngIf="flipDirection === 'forward'" 
             class="flipping-page-forward absolute"
             style="width: 42.5vw; max-width: 600px; height: 80vh; max-height: 800px; 
                    right: calc(7.5vw); 
                    transform-style: preserve-3d;">
          
          <!-- Page Slices -->
          <div class="page-slices-container" style="display: flex; width: 100%; height: 100%; transform-style: preserve-3d;">
            <div *ngFor="let slice of getSliceArray()" 
                 class="page-slice"
                 [style.width.%]="100 / sliceCount"
                 [style.transform]="getSliceTransform(slice)"
                 [style.filter]="getSliceBrightness(slice)"
                 style="height: 100%; 
                        transform-origin: left center; 
                        transform-style: preserve-3d;
                        backface-visibility: hidden;
                        background: white;
                        overflow: hidden;
                        position: relative;">
              
              <!-- Slice content (portion of the page image) -->
              <div style="position: absolute; 
                          width: 2500%; 
                          height: 100%; 
                          left: 0;
                          transform-origin: left center;"
                   [style.left.%]="-(slice * 100)">
                <img *ngIf="pages[currentPage - 1]" 
                     [src]="pages[currentPage - 1]" 
                     style="width: 100%; height: 100%; object-fit: contain; padding: 2%;"
                     alt="Flipping page">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Backward Flip (Left page flipping right) with Slices -->
        <div *ngIf="flipDirection === 'backward'" 
             class="flipping-page-backward absolute"
             style="width: 42.5vw; max-width: 600px; height: 80vh; max-height: 800px; 
                    left: calc(7.5vw); 
                    transform-style: preserve-3d;">
          
          <!-- Page Slices -->
          <div class="page-slices-container" style="display: flex; width: 100%; height: 100%; transform-style: preserve-3d;">
            <div *ngFor="let slice of getSliceArray()" 
                 class="page-slice"
                 [style.width.%]="100 / sliceCount"
                 [style.transform]="getSliceTransform(slice)"
                 [style.filter]="getSliceBrightness(slice)"
                 style="height: 100%; 
                        transform-origin: right center; 
                        transform-style: preserve-3d;
                        backface-visibility: hidden;
                        background: white;
                        overflow: hidden;
                        position: relative;">
              
              <!-- Slice content (portion of the page image) -->
              <div style="position: absolute; 
                          width: 2500%; 
                          height: 100%; 
                          right: 0;
                          transform-origin: right center;"
                   [style.right.%]="-(slice * 100)">
                <img *ngIf="currentPage > 1 && pages[currentPage - 2]" 
                     [src]="pages[currentPage - 2]" 
                     style="width: 100%; height: 100%; object-fit: contain; padding: 2%;"
                     alt="Flipping page">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Dynamic Shadow during flip -->
        <div class="flip-shadow absolute pointer-events-none"
             [ngClass]="flipDirection === 'forward' ? 'flip-shadow-forward' : 'flip-shadow-backward'"
             style="width: 42.5vw; max-width: 600px; height: 80vh; max-height: 800px;">        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation Bar (like in the image) -->
  <div class="absolute bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-600 px-6 py-3 flex items-center justify-center gap-4 z-20">
    
    <!-- Zoom Out -->
    <button (click)="zoomOut()" 
            [disabled]="zoomLevel <= 0.5"
            class="text-white hover:text-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed p-2 transition-colors" 
            title="Zoom Out">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
      </svg>
    </button>

    <!-- Previous Page -->
    <button (click)="previousPage()" 
            [disabled]="currentPage <= 1"
            class="text-white hover:text-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed p-2 transition-colors"
            title="Previous Page">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>

    <!-- Play/Pause Auto Play -->
    <button (click)="toggleAutoPlay()" 
            [class.text-green-400]="isAutoPlay"
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Auto Play">
      <svg *ngIf="!isAutoPlay" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <svg *ngIf="isAutoPlay" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </button>

    <!-- Page Input -->
    <div class="flex items-center gap-2">
      <input type="number" 
             [(ngModel)]="currentPage"
             (change)="goToPage()"
             min="1" 
             [max]="totalPages"
             class="w-16 bg-gray-700 text-white text-center border border-gray-600 rounded px-2 py-1 text-sm focus:outline-none focus:border-gray-500">
      <span class="text-white text-sm">/ {{ totalPages }}</span>
    </div>

    <!-- Next Page -->
    <button (click)="nextPage()" 
            [disabled]="currentPage >= totalPages"
            class="text-white hover:text-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed p-2 transition-colors"
            title="Next Page">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>

    <!-- Zoom In -->
    <button (click)="zoomIn()" 
            [disabled]="zoomLevel >= 3"
            class="text-white hover:text-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed p-2 transition-colors" 
            title="Zoom In">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
      </svg>
    </button>

    <!-- Divider -->
    <div class="h-6 w-px bg-gray-600 mx-2"></div>

    <!-- Fit Width -->
    <button (click)="fitWidth()" 
            [class.text-blue-400]="fitMode === 'width'"
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Fit Width">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
      </svg>
    </button>

    <!-- Fit Page -->
    <button (click)="fitPage()" 
            [class.text-blue-400]="fitMode === 'page'"
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Fit Page">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
    </button>

    <!-- Auto Fit -->
    <button (click)="autoFit()" 
            [class.text-blue-400]="fitMode === 'auto'"
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Auto Fit">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
    </button>

    <!-- Divider -->
    <div class="h-6 w-px bg-gray-600 mx-2"></div>

    <!-- Download -->
    <button (click)="downloadPdf()" 
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Download">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
      </svg>
    </button>

    <!-- Print -->
    <button (click)="printPdf()" 
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Print">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
      </svg>
    </button>

    <!-- Bookmark -->
    <button (click)="bookmarkPage()" 
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Bookmark This Page">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
      </svg>
    </button>

    <!-- Load Bookmark -->
    <button (click)="toggleBookmarksPanel()" 
            [class.text-blue-400]="showBookmarksPanel"
            class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="View All Bookmarks">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
      </svg>
    </button>

    <!-- Help -->
    <button class="text-white hover:text-gray-300 p-2 transition-colors" 
            title="Keyboard Shortcuts: ← → for pages, Home/End for first/last page">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </button>
  </div>

  <!-- Bookmarks Side Panel -->
  <div *ngIf="showBookmarksPanel" 
       class="fixed right-0 top-0 bottom-0 w-80 bg-gray-800 shadow-2xl z-50 transform transition-transform duration-300"
       style="border-left: 2px solid #4B5563;">
    
    <!-- Panel Header -->
    <div class="bg-gray-900 px-6 py-4 flex items-center justify-between border-b border-gray-700">
      <div class="flex items-center gap-3">
        <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
        </svg>
        <h3 class="text-white text-lg font-semibold">Bookmarks</h3>
      </div>
      <button (click)="toggleBookmarksPanel()" 
              class="text-gray-400 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Bookmarks List -->
    <div class="overflow-y-auto h-full pb-20">
      <div *ngIf="bookmarks.length === 0" class="p-6 text-center">
        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
        </svg>
        <p class="text-gray-400 text-sm">No bookmarks yet</p>
        <p class="text-gray-500 text-xs mt-2">Click the bookmark icon to save pages</p>
      </div>

      <div *ngFor="let page of bookmarks" 
           class="border-b border-gray-700 hover:bg-gray-700 transition-colors cursor-pointer group">
        <div class="p-4 flex items-center justify-between">
          <div (click)="goToBookmark(page)" class="flex-1 flex items-center gap-4">
            <!-- Page Thumbnail -->
            <div class="w-16 h-20 bg-gray-900 rounded overflow-hidden flex-shrink-0 border border-gray-600">
              <img *ngIf="pages[page - 1]" 
                   [src]="pages[page - 1]" 
                   class="w-full h-full object-cover"
                   alt="Page {{page}}">
            </div>
            
            <!-- Page Info -->
            <div class="flex-1">
              <p class="text-white font-medium">Page {{ page }}</p>
              <p class="text-gray-400 text-sm">Click to navigate</p>
            </div>
          </div>

          <!-- Remove Button -->
          <button (click)="removeBookmark(page)" 
                  class="text-gray-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100 p-2"
                  title="Remove bookmark">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div *ngIf="showBookmarksPanel" 
       (click)="toggleBookmarksPanel()"
       class="fixed inset-0 bg-black/50 z-40 transition-opacity duration-300">
  </div>

</div>
