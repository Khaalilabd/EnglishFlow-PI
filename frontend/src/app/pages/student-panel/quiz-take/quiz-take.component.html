<div class="quiz-take-container">
  <!-- Loading State -->
  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading quiz...</p>
    </div>
  }

  <!-- Quiz Start Screen -->
  @if (!loading && !quizStarted && !quizFinished && quiz && !hasCompletedAttempt) {
    <div class="quiz-start">
      <div class="quiz-icon">üìù</div>
      <h2>{{ quiz.title }}</h2>
      @if (quiz.description) {
        <p class="quiz-description">{{ quiz.description }}</p>
      }
      
      <div class="quiz-info">
        <div class="info-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>{{ totalQuestions }} Questions</span>
        </div>
        @if (quiz.durationMin) {
          <div class="info-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>{{ quiz.durationMin }} minutes</span>
          </div>
        }
        <div class="info-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>Passing Score: {{ quiz.passingScore }}%</span>
        </div>
      </div>

      <button class="start-btn" (click)="startQuiz()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Start Quiz
      </button>
    </div>
  }

  <!-- Quiz Questions -->
  @if (quizStarted && !quizFinished && currentQuestion) {
    <div class="quiz-content">
      <!-- Header with Timer and Title -->
      <div class="quiz-header-bar">
        <div class="quiz-title-section">
          <h2>{{ quiz?.title }}</h2>
          <p class="question-count">Question {{ currentQuestionIndex + 1 }} of {{ totalQuestions }}</p>
        </div>
        @if (quiz?.durationMin) {
          <div class="timer-display" [class.time-warning]="timeRemaining < 300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="timer-text">{{ formatTime(timeRemaining) }}</span>
            <span class="timer-label">Time Remaining</span>
          </div>
        }
      </div>

      <!-- Progress Bar -->
      <div class="quiz-progress">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
        </div>
        <div class="progress-text">
          <span>Progress</span>
          <span>{{ Math.round(getProgressPercentage()) }}%</span>
        </div>
      </div>

      <!-- Question Map -->
      <div class="question-map-section">
        <h3 class="question-map-title">Question Map</h3>
        <div class="question-map-legend">
          <span class="legend-item"><span class="dot answered"></span> Answered</span>
          <span class="legend-item"><span class="dot flagged"></span> Flagged</span>
          <span class="legend-item"><span class="dot current"></span> Current</span>
        </div>
        <div class="question-map-grid">
          @for (question of questions; track question.id; let i = $index) {
            <button 
              class="question-map-btn"
              [class.answered]="getQuestionStatus(i) === 'answered'"
              [class.flagged]="getQuestionStatus(i) === 'flagged'"
              [class.current]="getQuestionStatus(i) === 'current'"
              (click)="goToQuestion(i)">
              {{ i + 1 }}
            </button>
          }
        </div>
      </div>

      <!-- Question Card -->
      <div class="question-card">
        <div class="question-header">
          <span class="question-number">{{ currentQuestion.content }}</span>
          @if (currentQuestion.points) {
            <span class="question-points">{{ currentQuestion.points }} pts</span>
          }
        </div>

        <!-- Answer Options -->
        <div class="answer-options">
          @if (currentQuestion.type === 'MCQ') {
            @if (currentQuestion.options) {
              @for (option of currentQuestion.options.split('|'); track option; let i = $index) {
                <button 
                  class="option-btn"
                  [class.selected]="isAnswerSelected(currentQuestion.id!, option)"
                  (click)="selectAnswer(currentQuestion.id!, option)">
                  <div class="option-indicator">
                    <span class="option-letter">{{ ['A', 'B', 'C', 'D'][i] }}</span>
                  </div>
                  <span class="option-text">{{ option }}</span>
                  @if (isAnswerSelected(currentQuestion.id!, option)) {
                    <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                  }
                </button>
              }
            }
          }

          @if (currentQuestion.type === 'TRUE_FALSE') {
            <button 
              class="option-btn"
              [class.selected]="isAnswerSelected(currentQuestion.id!, 'TRUE')"
              (click)="selectAnswer(currentQuestion.id!, 'TRUE')">
              <div class="option-indicator">
                <span class="option-letter">T</span>
              </div>
              <span class="option-text">True</span>
              @if (isAnswerSelected(currentQuestion.id!, 'TRUE')) {
                <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              }
            </button>
            <button 
              class="option-btn"
              [class.selected]="isAnswerSelected(currentQuestion.id!, 'FALSE')"
              (click)="selectAnswer(currentQuestion.id!, 'FALSE')">
              <div class="option-indicator">
                <span class="option-letter">F</span>
              </div>
              <span class="option-text">False</span>
              @if (isAnswerSelected(currentQuestion.id!, 'FALSE')) {
                <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              }
            </button>
          }
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="quiz-navigation">
        <div class="nav-left">
          <button 
            class="nav-btn prev-btn"
            [disabled]="!canGoPrevious()"
            (click)="previousQuestion()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Prev
          </button>

          <button 
            class="nav-btn flag-btn"
            [class.flagged]="isFlagged(currentQuestion.id!)"
            (click)="toggleFlag()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
            </svg>
            Flag
          </button>

          <button 
            class="nav-btn cancel-btn"
            (click)="cancelQuiz()">
            Cancel
          </button>
        </div>

        @if (currentQuestionIndex < totalQuestions - 1) {
          <button 
            class="nav-btn next-btn"
            (click)="nextQuestion()">
            Next
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        } @else {
          <button 
            class="nav-btn submit-btn"
            [disabled]="submitting"
            (click)="submitQuiz()">
            @if (submitting) {
              <span class="spinner-small"></span>
              Submitting...
            } @else {
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Submit Quiz
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- Quiz Results -->
  @if (quizFinished && quiz) {
    <div class="quiz-results">
      <div class="result-icon" [class.passed]="score >= quiz.passingScore!" [class.failed]="score < quiz.passingScore!">
        @if (score >= quiz.passingScore!) {
          üéâ
        } @else {
          üòî
        }
      </div>
      
      @if (hasCompletedAttempt) {
        <h2>Quiz Already Completed</h2>
        <p class="completed-notice">You have already completed this quiz. Here are your results:</p>
      } @else {
        <h2>Quiz Completed!</h2>
      }
      
      <div class="score-display">
        <div class="score-circle" [class.passed]="score >= quiz.passingScore!" [class.failed]="score < quiz.passingScore!">
          <span class="score-value">{{ score }}%</span>
        </div>
      </div>

      <div class="result-message">
        @if (score >= quiz.passingScore!) {
          <p class="success-message">
            @if (hasCompletedAttempt) {
              You passed this quiz! üéä
            } @else {
              Congratulations! You passed the quiz! üéä
            }
          </p>
        } @else {
          <p class="fail-message">
            @if (hasCompletedAttempt) {
              Score: {{ score }}% (Passing: {{ quiz.passingScore }}%)
            } @else {
              You need {{ quiz.passingScore }}% to pass. Keep learning and try again!
            }
          </p>
        }
      </div>

      <div class="result-stats">
        @if (previousAttempt) {
          <div class="stat-item">
            <span class="stat-label">Your Score</span>
            <span class="stat-value">{{ previousAttempt.score }}/{{ previousAttempt.maxScore }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Percentage</span>
            <span class="stat-value">{{ score }}%</span>
          </div>
        } @else {
          <div class="stat-item">
            <span class="stat-label">Correct Answers</span>
            <span class="stat-value">{{ Math.round(score * totalQuestions / 100) }}/{{ totalQuestions }}</span>
          </div>
        }
        <div class="stat-item">
          <span class="stat-label">Passing Score</span>
          <span class="stat-value">{{ quiz.passingScore }}%</span>
        </div>
      </div>

      @if (!hasCompletedAttempt) {
        <p class="auto-continue">Continuing to next lesson...</p>
      }
    </div>
  }
</div>
