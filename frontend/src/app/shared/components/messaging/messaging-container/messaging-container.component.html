<div class="messaging-app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1 class="app-title">Messages</h1>
      <button class="btn-compose" (click)="showNewConversationModal = true" title="Nouvelle conversation">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
      </button>
    </div>

    <div class="search-box">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" placeholder="Rechercher..." [(ngModel)]="searchQuery" (input)="filterConversations()">
    </div>

    <div class="conversations-list">
      <div *ngFor="let conv of filteredConversations" 
           class="conversation-card"
           [class.active]="selectedConversationId === conv.id"
           (click)="selectConversation(conv.id)">
        <div class="conv-avatar">
          <img [src]="getAvatar(conv)" [alt]="getTitle(conv)">
          <span class="status-dot" [class.online]="isOnline(conv)"></span>
        </div>
        <div class="conv-info">
          <div class="conv-top">
            <h3 class="conv-name">{{ getTitle(conv) }}</h3>
            <span class="conv-time">{{ formatTime(conv.lastMessageAt) }}</span>
          </div>
          <div class="conv-bottom">
            <p class="conv-preview">{{ conv.lastMessage?.content || 'Aucun message' }}</p>
            <span class="unread-badge" *ngIf="conv.unreadCount > 0">{{ conv.unreadCount }}</span>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Chat Area -->
  <main class="chat-area">
    <div *ngIf="!selectedConversation" class="empty-state">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
      </div>
      <h2>Sélectionnez une conversation</h2>
      <p>Choisissez une conversation pour commencer à discuter</p>
    </div>

    <div *ngIf="selectedConversation" class="chat-container">
      <!-- Chat Header -->
      <header class="chat-header">
        <div class="header-left">
          <div class="header-avatar">
            <img [src]="getAvatar(selectedConversation)" [alt]="getTitle(selectedConversation)">
            <span class="status-dot" [class.online]="isOnline(selectedConversation)"></span>
          </div>
          <div class="header-info">
            <h2>{{ getTitle(selectedConversation) }}</h2>
            <span class="status-text">{{ isOnline(selectedConversation) ? 'En ligne' : 'Hors ligne' }}</span>
          </div>
        </div>
        <div class="header-actions">
          <button class="icon-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </button>
          <button class="icon-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="1"/>
              <circle cx="12" cy="5" r="1"/>
              <circle cx="12" cy="19" r="1"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- Messages -->
      <div class="messages-area" #messagesArea>
        <div *ngFor="let msg of messages" 
             class="message"
             [class.sent]="msg.senderId === currentUserId"
             [class.received]="msg.senderId !== currentUserId">
          <div class="message-avatar" *ngIf="msg.senderId !== currentUserId">
            <img [src]="msg.senderAvatar && !msg.senderAvatar.includes('ui-avatars.com') ? 'http://localhost:8080' + msg.senderAvatar : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(msg.senderName) + '&background=667eea&color=fff&bold=true&size=128'" 
                 [alt]="msg.senderName">
          </div>
          <div class="message-bubble">
            <div class="message-content">
              <p>{{ msg.content }}</p>
              <span class="message-time">{{ formatMessageTime(msg.createdAt) }}</span>
            </div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="isTyping" class="message received">
          <div class="message-avatar">
            <img [src]="getAvatar(selectedConversation!)" [alt]="getTitle(selectedConversation!)">
          </div>
          <div class="message-bubble">
            <div class="message-content typing-indicator">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <footer class="chat-footer">
        <button class="icon-btn emoji-btn" (click)="toggleEmojiPicker()" title="Ajouter un emoji">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10" stroke-width="2"/>
            <path d="M8 14s1.5 2 4 2 4-2 4-2" stroke-width="2" stroke-linecap="round"/>
            <circle cx="9" cy="9" r="1" fill="currentColor"/>
            <circle cx="15" cy="9" r="1" fill="currentColor"/>
          </svg>
        </button>
        <div class="input-wrapper">
          <input #messageInput
                 type="text" 
                 placeholder="Tapez votre message..." 
                 [(ngModel)]="newMessage"
                 (keyup.enter)="sendMessage()"
                 (input)="onTyping()">
        </div>
        <button class="send-btn" [class.active]="newMessage.trim()" (click)="sendMessage()" title="Envoyer">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </footer>
      
      <!-- Simple Emoji Picker -->
      <div class="emoji-picker-container" *ngIf="showEmojiPicker">
        <div class="emoji-picker-backdrop" (click)="toggleEmojiPicker()"></div>
        <div class="emoji-picker-wrapper">
          <div class="emoji-picker-header">
            <h4>Choisir un emoji</h4>
            <button class="close-btn" (click)="toggleEmojiPicker()">×</button>
          </div>
          <div class="emoji-grid">
            <button *ngFor="let emoji of popularEmojis" 
                    class="emoji-item" 
                    (click)="insertEmoji(emoji)">
              {{ emoji }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<app-new-conversation-modal
  *ngIf="showNewConversationModal"
  (close)="showNewConversationModal = false"
  (conversationCreated)="onConversationCreated($event)"
></app-new-conversation-modal>
